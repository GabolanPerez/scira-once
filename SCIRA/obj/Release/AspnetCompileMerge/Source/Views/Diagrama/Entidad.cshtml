@model IEnumerable<SCIRA.Models.c_entidad>
@using SCIRA.Utilidades

@{

    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = "Diagrama Entidades";

    List<int> hasDiagram = ViewBag.hasDiagram;
    List<int> HasHistorial = ViewBag.HasHistorial;
}

<button class="btn btn-circle btn-default pull-right" title="Tutorial" onclick="runTutorial();"><i class="fa fa-question fa-lg"></i></button>

<h2><span class="catalogName">@Strings.getMSG("DiagramaEntidadIndex001")</span></h2>

<table id="results" class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th class="search">@Strings.getMSG("Entidad")</th>
            <th class="search">@Strings.getMSG("Responsable")</th>
            <th class="search">@Strings.getMSG("EntidadIndex001")</th>
            <th class="search">@Strings.getMSG("DiagramaEntidadIndex002")</th>
            <th width="80"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @( item.cl_entidad + " - " + item.nb_entidad)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.c_usuario.nb_usuario)
                </td>
                <td>
                    @SCIRA.Utilidades.Utilidades.PuestoUsuario(item.id_responsable)
                </td>
                <td id="tieneDiagrama@(item.id_entidad)">
                    @(hasDiagram.Contains(item.id_entidad) ? @Strings.getMSG("UsuarioIndex004") : @Strings.getMSG("UsuarioIndex005"))
                </td>
                <td>
                    <center>
                        <a href="@Url.Action("EditorEN", new { id = item.id_entidad })" class="diagram">
                            <i class="fa fa-object-ungroup @(hasDiagram.Contains(item.id_entidad) ? "text-success":"text-danger")" id="diagButton@(item.id_entidad)" title="@Strings.getMSG("RiesgoCreate097")"></i>
                        </a>
                        @if (hasDiagram.Contains(item.id_entidad) && false)
                        {
                            <span id="diagDelButton@(item.id_entidad)">
                                |
                                <a href="javascript:void(0)" onclick="deleteDiagram('@item.nb_entidad',@item.id_entidad)" class="diagram">
                                    <i class="fa fa-trash" title="@Strings.getMSG("Borrar")"></i>
                                </a>
                            </span>
                        }
                        @if (HasHistorial.Contains(item.id_entidad))
                        {
                            <span>
                                |
                                <a href="@Url.Action("HistorialEN", new { id = item.id_entidad})">
                                    <i class="fa fa-history fa-lg" title="@Strings.getMSG("Historial de cambios")"></i>
                                </a>
                            </span>
                        }
                    </center>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    var options = {
        title: '',
        action: 'deleteDiagramPost()'
    };

    var idDiagrama = 0;
    var baseUrl = "@Url.Action("Delete","Diagrama")";
    var executeUrl;

    function deleteDiagram(nbreg, idReg) {
        options.title = "@(Strings.getMSG("DiagramaEntidadIndex013")) '" + nbreg + "'@(Strings.getMSG("DiagramaEntidadIndex014"))";
        idDiagrama = idReg
        executeUrl = baseUrl + "?id=" + idReg + "&clave=EN";
        confirmationModal.initModal(options);
    }


    function deleteDiagramPost() {
        executePost(executeUrl, null, 'deleteDiagramSuccess()','deleteDiagramError()');
    }


    function deleteDiagramSuccess() {
        toastr.success("@(Strings.getMSG("DiagramaEntidadIndex015"))");
        $("#diagButton" + idDiagrama).removeClass('text-success');
        $("#diagButton" + idDiagrama).addClass('text-danger');
        $("#diagDelButton" + idDiagrama).remove();
        $("#tieneDiagrama2040").text("@Strings.getMSG("UsuarioIndex005")");
    }

    function deleteDiagramError() {
        toastr.error("@Strings.getMSG("AvisoError003")");
    }

</script>