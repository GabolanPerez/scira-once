@model SCIRA.Models.r_evento
@using SCIRA.Utilidades
@using SCIRA.Seguridad
@{
    var db = new SCIRA.Models.SICIEntities();
    var reg = SCIRA.Utilidades.Utilidades.GetLastReg(Model, db);
    IdentityPersonalizado user = (IdentityPersonalizado)User.Identity;
}


<script src="~/Scripts/dropzone-config.js"></script>


<script>
    $(document).ready(function () {
        menuModal.setTitle('@ViewBag.title');
    });

    function trySubmit() {
        var url = "@(Url.Action("FichaSA", "Ficha"))";
        var message = "@Strings.getMSG("CosteoIndex006")";

        executePost(url, "FichaForm", "toastr.success(\"" + message + "\");menuModal.hide();", "toastr.error(\"@Strings.getMSG("AvisoError003")\");menuModal.hide();");
    }

    function endTask() {
        var url = "@(Url.Action("EndTask", "Ficha"))";

        executePost(url, "EndTaskForm", "ETS();", "ETE();");
    }

    function ETS() {
        var message = "@Strings.getMSG("PendientesVerTodoIndex012")";
        toastr.success(message);
        $("#statInput").val('Finalizado');
        $("#endButton").hide();
    }

    function ETE() {
        toastr.error("@Strings.getMSG("AvisoError003")");
    }

</script>

@if (ViewBag.tipo == "0001")
{
<button class="btn btn-default" onclick="menuModal.bodyLoad('@Url.Action("ContenidoNormatividadI","NormatividadOperacion")/@ViewBag.id_objeto')">@Strings.getMSG("Atrás")</button>
}

<br />
<br />
<br />

<form id="EndTaskForm" hidden>

    @Html.AntiForgeryToken()
    <input type="text" name="id" value="@reg.id_registro" />

</form>

<div id="accordion">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#SECC001">
                    @Strings.getMSG("Datos de la Ficha")
                </a>
                @if (ViewBag.showEditButton != null) { 
                    <a href="javascript:void(0);" onclick="menuModal.bodyLoad('@Url.Action("EditFromSomewhere","Ficha")/@Model.id_evento')"><i class="glyphicon glyphicon-pencil text-danger" title="@Strings.getMSG("Editar")"></i></a>
                }
            </h4>
        </div>
        <div id="SECC001" class="panel-collapse collapse in">
            <div class="panel-body">
                <form id="FichaForm" method="post">
                    <div class="form-horizontal">

                        <input type="hidden" name="id_evento" value="@Model.id_evento" />
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="form-group col-xs-12 ">
                                <label class="control-label col-xs-3 col-sm-2 col-md-2 col-lg-2">@Strings.getMSG("lyPIndex009")</label>
                                <div class="col-xs-9 col-sm-10 col-md-10 col-lg-10">
                                    <div class="input-group col-xs-12">
                                        @Html.EditorFor(model => model.nb_evento, new { htmlAttributes = new { @class = "form-control", @readonly = "true" } })
                                    </div>
                                </div>
                            </div>


                            <div class="form-group col-xs-12">
                                <label class="control-label col-xs-3 col-sm-2 col-md-2 col-lg-2">@Strings.getMSG("BDEICreate005")</label>
                                <div class="col-xs-6 col-sm-7 col-md-4 col-lg-4">
                                    <div class="input-group">
                                        <input class="form-control" id="statInput" readonly value="@Utilidades.GetStatus(Model)" />
                                    </div>
                                </div>

                                @if (!reg.terminado)
                                {
                                    <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3" id="endButton">
                                        <input type="button" value=@Strings.getMSG("Finalizar") class="btn btn-default pull-right" @(user.Solo_lectura ? "disabled" : "") onclick='confirmationModal.initModal({title: "@Strings.getMSG("PendientesFichasIndex004")",action: "endTask()"});' />
                                    </div>
                                }

                            </div>
                        </div>

                        <br />

                        <div class="row ">
                            <div class="form-group col-xs-12">
                                <label class="control-label col-xs-3 col-sm-2 col-md-2 col-lg-2">@Strings.getMSG("NotificationEdit003")</label>
                                <div class="col-xs-9 col-sm-10 col-md-10 col-lg-10">
                                    @Html.TextAreaFor(model => model.ds_evento, new { @spellcheck = "false", @id = "area1", @class = "form-control", @cols = "50", @rows = "15", @readonly = "true" })
                                </div>
                            </div>
                        </div>
                        <select multiple id="files" name="files" hidden></select>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#SECC002">
                    @Strings.getMSG("lyPIndex027")
                </a>
            </h4>
        </div>
        <div id="SECC002" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="form-horizontal">
                    <div class="row">
                        <label class="control-label col-xs-3 col-sm-2 col-md-2 col-lg-2">@Strings.getMSG("RevisionControlRevisiones003")</label>
                        <div class="col-xs-9 col-sm-10 col-md-10 col-lg-10">
                            <form action="@Url.Action("Upload","Archivos")"
                                  class="dropzone"
                                  data-target="files"
                                  id="fileUploader"></form>
                            <!--data-target es el elemento select multiple a donde se agregaran los ids de los archivos elegidos-->
                            <!--el id siempre debera ser fileUploader-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#SECC003">
                    @Strings.getMSG("lyPIndex028")
                </a>
            </h4>
        </div>
        <div id="SECC003" class="panel-collapse collapse">
            <div class="panel-body">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>@Strings.getMSG("RevisionControlRevisiones006")</th>
                            <th>@Strings.getMSG("BDEIIndex003")</th>
                            <th width="80px"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var file in Model.c_archivo)
                        {
                            <tr id="fr@(file.id_archivo)">
                                <td>@file.nb_archivo</td>
                                <td>@file.fe_alta.Value.ToString("dd/MM/yyyy hh:mm")</td>
                                <td> 
                                    <center>
                                        <a href="@Url.Action("Download","Archivos", new { id = file.id_archivo})"><i class="fa fa-download" title=@Strings.getMSG("Descargar")></i></a>
                                    </center>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="row">
    <div class="pull-right col-md-2">
        <input type="button" id="smtBtn" class="btn btn-primary" value="@Strings.getMSG("Guardar")" @(user.Solo_lectura ? "disabled" : "") onclick="trySubmit()" />
    </div>
</div>



