@model IEnumerable<SCIRA.Models.c_sub_proceso>
@using SCIRA.Models;
@using SCIRA.Utilidades
@{
    var db = new SICIEntities();
    var actividades = db.c_area_costeo.ToList();

    bool AnyActivityL3 = db.c_area_costeo_n3.Count() > 0;

    ViewBag.Title = "Reporte de Sub Actividades Costeo";
    Layout = "~/Views/Shared/_LayoutReporte.cshtml";
}


<h2>@Strings.getMSG("Menu115")</h2>

<br />
<br />


@if (AnyActivityL3)
{

<table id="results" class="results table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th class="search" rowspan="3">@Strings.getMSG("Entidad")</th>
            <th class="search" rowspan="3">@Strings.getMSG("ReporteEstructuraIndex001")</th>
            <th class="search" rowspan="3">@Strings.getMSG("MP")</th>
            <th class="search" rowspan="3">@Strings.getMSG("ReporteEstructuraIndex002")</th>
            <th class="search" rowspan="3">@Strings.getMSG("P")</th>
            <th class="search" rowspan="3">@Strings.getMSG("ReporteEstructuraIndex003")</th>
            <th class="search" rowspan="3">@Strings.getMSG("SP")</th>
            <th class="search" rowspan="3">@Strings.getMSG("RiesgoCreate037")</th>
            @foreach (var ac in actividades)
            {
                var ac2L = ac.c_area_costeo_n2.ToList();
                List<c_area_costeo_n3> ac3L = new List<c_area_costeo_n3>();
                foreach (var ac2 in ac2L)
                {
                    ac3L.AddRange(ac2.c_area_costeo_n3.ToList());
                }
                if (ac3L.Count() > 0)
                {
                    <th colspan="@ac3L.Count()"><center>@ac.nb_area_costeo</center></th>
                }
            }
        </tr>
        <tr>
            @foreach (var ac in actividades)
            {
                var ac2L = ac.c_area_costeo_n2.ToList();
                foreach (var ac2 in ac2L)
                {
                    if (ac2.c_area_costeo_n3.Count() > 0)
                    {
                        <th colspan="@ac2.c_area_costeo_n3.Count()"><center>@ac2.nb_area_costeo_n2</center></th>
                    }

                }
            }
        </tr>
        <tr>
            @foreach (var ac in actividades)
            {
                var ac2L = ac.c_area_costeo_n2.ToList();
                foreach (var ac2 in ac2L)
                {
                    foreach (var ac3 in ac2.c_area_costeo_n3)
                    {
                        <th><center>@ac3.nb_area_costeo_n3</center></th>
                    }
                }
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var sp in Model)
        {
            var p = sp.c_proceso;
            var mp = p.c_macro_proceso;
            var e = mp.c_entidad;
        <tr>
            <td>@e.cl_entidad - @e.nb_entidad</td>
            <td>@e.c_usuario.nb_usuario</td>
            <td>@mp.cl_macro_proceso - @mp.nb_macro_proceso</td>
            <td>@mp.c_usuario.nb_usuario</td>
            <td>@p.cl_proceso - @p.nb_proceso</td>
            <td>@p.c_usuario.nb_usuario</td>
            <td>@sp.cl_sub_proceso - @sp.nb_sub_proceso</td>
            <td>@sp.c_usuario.nb_usuario</td>
            @foreach (var ac in actividades)
            {
                var ac2L = ac.c_area_costeo_n2.ToList();
                if (sp.c_area_costeo_sub_proceso.Where(axc => axc.id_area_costeo == ac.id_area_costeo).Count() > 0)
                {

                    foreach (var ac2 in ac2L)
                    {
                        var ac3L = ac2.c_area_costeo_n3.ToList();

                        foreach (var ac3 in ac3L)
                        {
                            if (sp.c_area_costeo_n3_sub_proceso.Where(axc3 => axc3.id_area_costeo_n3 == ac3.id_area_costeo_n3).Count() > 0)
                            {
                                double auxP = (double)sp.c_area_costeo_n3_sub_proceso.Where(axc3 => axc3.id_area_costeo_n3 == ac3.id_area_costeo_n3).First().porcentaje;

            <td><center>@auxP.ToString().Replace(",", ".")</center></td>
                            }
                            else
                            {
            <td><center>0</center></td>
                            }
                        }
                    }
                }
                else
                {
                    foreach (var ac2 in ac2L)
                    {
                        var ac3L = ac2.c_area_costeo_n3.ToList();
                        foreach (var ac3 in ac3L)
                        {
                            <td style="background-color:gray;color:white"><center>N/A</center></td>
                        }
                    }


                }
            }
        </tr>
        }
    </tbody>
</table>


}
else
{
<script>
    $(document).ready(function () {
        menuModal.setTitle("@Strings.getMSG("Aviso")");
        $("#menuModal .partialModal").html("<center><h3>@Strings.getMSG("ReporteCosteoIndex005")</h3></center>");
        menuModal.show();
    });
</script>
}