@model IEnumerable<SCIRA.Models.c_area_costeo_n3>
@using SCIRA.Models
@using SCIRA.Utilidades
@{
    c_sub_proceso sp = ViewBag.sp;
    c_area_costeo_n2 ac2 = ViewBag.ac2;
}

<script>
    var returnURL = '@(Url.Action("LVL2","Costeo"))';
    var submitURL = '@(Url.Action("SaveLVL3","Costeo"))';

    $(document).ready(function () {
        menuModal.setTitle('@sp.cl_sub_proceso/@ac2.c_area_costeo.nb_area_costeo/@ac2.nb_area_costeo_n2');
        initTables("#menuModal");

        //asignar valores a cada atributo
        @foreach(var ac in Model)
        {
            decimal aux = 0;
            if (ac.c_area_costeo_n3_sub_proceso.Where(ac3=>ac3.id_sub_proceso == sp.id_sub_proceso).Count() > 0)
            {
                var acn3sp = ac.c_area_costeo_n3_sub_proceso.Where(ac3 => ac3.id_sub_proceso == sp.id_sub_proceso).First();
                aux = acn3sp.porcentaje;
            }
            @:$("#ac@(ac.id_area_costeo_n3)").val(parseFloat("@aux.ToString().Replace(',','.')"));
        }

    });

    function trySubmit() {

        var sum = 0;

        $(".val").each(function () {
            var $this = $(this);
            var aux = parseFloat($this.val());

            if (isNaN(aux)) {
                $this.val(0);
                aux = 0;
            }

            sum = (aux + sum);
        })

        if (sum.toFixed(5) == 100) {
            executePost(
                submitURL,
                'form1',
                "submitSuccess()",
                "submitError()"
            );
        } else {
            if (sum < 100) {
                toastr.error("@Strings.getMSG("AvisoError001")"+parseFloat(sum.toFixed(5))+"@Strings.getMSG("AvisoError006")");
            } else if (sum > 100) {
                toastr.error("@Strings.getMSG("AvisoError001")"+parseFloat(sum.toFixed(5))+"@Strings.getMSG("AvisoError002")");
            }
        }
    }

    function submitSuccess() {
        toastr.success("@Strings.getMSG("CosteoIndex006")");
    }

    function submitError() {
        toastr.error("@Strings.getMSG("AvisoError003")");
    }

</script>



<input type="button" class="btn btn-default" value="@Strings.getMSG("Regresar")" onclick="menuModal.bodyLoad(returnURL,null,$('#form2').serialize())" />
<br />
<br />


<form id="form1">
    @Html.AntiForgeryToken()
    <table class="results table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>
                    @Strings.getMSG("CosteoIndex005")
                </th>
                <th>
                    @Strings.getMSG("RiesgoResidualConfigIndex020")
                </th>
            </tr>
        </thead>

        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @item.cl_area_costeo_n3 - @item.nb_area_costeo_n3
                    </td>
                    <td>
                        <center>
                            <input type="number" class="form-control S1 val" id="ac@(item.id_area_costeo_n3)" name="vals[]" />
                            <input type="hidden" value="@item.id_area_costeo_n3" name="ids_attr[]" />
                        </center>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <input type="hidden" value="@sp.id_sub_proceso" name="id_sp" />
</form>

<br />
<br />

<input type="button" class="btn btn-primary pull-right" value="@Strings.getMSG("Guardar")" onclick="trySubmit();" />

<br />
<br />

<form id="form2" hidden>
    <input type="hidden" id="f2i1" name="id_sp" value="@sp.id_sub_proceso" />
    <input type="hidden" id="f2i2" name="id_ac" value="@ac2.c_area_costeo.id_area_costeo" />
</form>