@model IEnumerable<SCIRA.Models.c_prueba_auditoria>
@using SCIRA.Utilidades
@{
    var db = new SCIRA.Models.SICIEntities();
    SCIRA.Models.k_auditoria kAuditoria = ViewBag.kAuditoria;
    Layout = "~/Views/Shared/_LayoutReporte.cshtml";
    ViewBag.Title = Strings.getMSG("AuditoriaIndexUniversoAuditable008");

    var Items = Model.OrderBy(m => m.no_orden).ToList();

    var camposE = db.c_campo_programa.OrderBy(c => c.cl_campo).ToList();
}

<h2>@Strings.getMSG("AuditoriaIndexUniversoAuditable008") @kAuditoria.c_auditoria.nb_auditoria</h2>

@Html.ActionLink(@Strings.getMSG("Regresar"), "IndexEjecucion", null, new { @class = "btn btn-default" })
<br />
<br />
<table class="results table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>@Strings.getMSG("NormatividadIndex004")</th>
            <th>@Strings.getMSG("Entidad")</th>
            <th>@Strings.getMSG("ProcesosAuditoriaIndexPlaneacion002")</th>
            <th>@Strings.getMSG("DivisionAuditoria001")</th>
            <th>@Strings.getMSG("AuditoriaIndexPruebaAuditoria002")</th>
            <th>@Strings.getMSG("SubProcesoCreate018")</th>
            <th>@Strings.getMSG("ProcesosAuditoriaPruebasEjecucion002")</th>
            <th>@Strings.getMSG("ProcesosAuditoriaPruebasEjecucion003")</th>
            <th>@Strings.getMSG("ProcesosAuditoriaPruebasEjecucion004")</th>
            <th>@Strings.getMSG("RevisionControlRevisiones003")</th>
            <th>@Strings.getMSG("RevisionControlRevisiones006")</th>
            @foreach (var ce in camposE)
            {
                <th>@ce.nb_campo</th>
            }
            <th width="40"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Items)
        {
            var programa = item.k_programa_trabajo.FirstOrDefault(p => p.idd_auditoria == kAuditoria.idd_auditoria);

            string incidencia = "N/A";
            string recomendaciones = "N/A";
            string resultado = "N/A";

            List<SCIRA.Models.c_archivo> files = new List<SCIRA.Models.c_archivo>();

            if (programa != null)
            {
                incidencia = programa.incidencia_detectada;
                recomendaciones = programa.recomendaciones;
                resultado = programa.resultado;
                files = programa.c_archivo.ToList();
            }
            else
            {
                programa = new SCIRA.Models.k_programa_trabajo();
            }

            <tr>
                <td>@item.no_orden</td>
                <td>@item.c_auditoria.c_entidad.nb_entidad</td>
                <td>@item.c_auditoria.nb_auditoria</td>
                <td>@((item.c_auditoria.id_division_auditoria ?? 0) != 0 ? item.c_auditoria.c_division_auditoria.ds_division_auditoria : "N/A")</td>
                <td>@item.nb_prueba_auditoria</td>
                <td>@item.ds_prueba_auditoria</td>
                <td>@resultado</td>
                <td>@incidencia</td>
                <td>@recomendaciones</td>
                <td>
                    @foreach (var file in files)
                    {
                        <a href="@Url.Action("Download","Archivos", new { id = file.id_archivo})"><i class="fa fa-file@(Utilidades.getFileClass(file))" title="@file.nb_archivo"></i></a>
                    }
                    @if (files.Count() == 0)
                    {
                        @:@Strings.getMSG("AuditoriaIndexSeguimientoObservaciones007")
                    }
                </td>
                <td>
                    @foreach (var file in files)
                    {
                        <p>@(file.nb_archivo+"."+file.extension)</p>
                    }
                    @if (files.Count() == 0)
                    {
                        @:@Strings.getMSG("AuditoriaIndexSeguimientoObservaciones007")
                    }
                </td>
                @foreach (var ce in camposE)
                {
                    var ice = programa.k_campo_programa.FirstOrDefault(p => p.id_campo_programa == ce.id_campo_programa);
                    string valor = "";
                    if(ice != null)
                    {
                        valor = ice.valor;
                    }
                <td>@valor</td>
                }
                <td>
                    <a href="@Url.Action("EditPrueba", new { id = item.id_prueba_auditoria,idd_auditoria = kAuditoria.idd_auditoria })">
                        <i class="glyphicon glyphicon-pencil" title="@Strings.getMSG("Editar")"></i>
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>
