@using SCIRA.Utilidades
@{
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = Strings.getMSG("RiesgoCreate082")+ " " + ViewBag.nb_contenido;

    string data = ViewBag.data;
}

<link href="~/Content/font-awesome.min.css" rel="stylesheet" />
<link href="~/Content/Extras.css" rel="stylesheet" />

<script src="~/Scripts/BootstrapMenu.min.js"></script>
<script src="~/Scripts/sharedScripts.js"></script>

<script src="~/Scripts/Certificacion.js"></script>
<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-select.js"></script>

<script src="~/Scripts/OrgChart.js"></script>

<style type="text/css">

    .node.noPermission rect {
        fill: #a09e9e;
    }
</style>

<script>

    var imgURL = '@Url.Action("DisplayIMG")?id=';
    var deleteImgURL = '@Url.Action("DeleteIMG")?id=';

    function canMoveL(id) {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("CanEdit", "Manuales"))',
            data: {id:id, UserID:UserID},
                success: function (data) {
                    if (data == "1") moveL(id);
                    else toastr.warning("@Strings.getMSG("ManualesCreate011")");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
    }

    function canMoveR(id) {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("CanEdit", "Manuales"))',
            data: {id:id, UserID:UserID},
                success: function (data) {
                    if (data == "1") moveR(id);
                    else toastr.warning("@Strings.getMSG("ManualesCreate011")");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
    }

    function canDeleteImg(id) {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("CanEdit", "Manuales"))',
            data: {id:id, UserID:UserID},
                success: function (data) {
                    if (data == "1") deleteImg(id);
                    else toastr.warning("@Strings.getMSG("ManualesCreate011")");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
            }
        });
    }

    function moveL(id) {
        move(id, 0);
    }

    function moveR(id) {
        move(id, 1);
    }

    function deleteImg(id) {
        executePost(deleteImgURL + id, null, "toastr.success('@Strings.getMSG("ManualesCreate012")');", "toastr.error('@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")');");
    }

    function getNextLvlName(id) {
        $(".lvlName").load('@(Url.Action("GetNextLevel", "Manuales", null))' + '/' + id);

        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("GetNextLevelID", "Manuales"))',
            data: { id:id },
            success: function (data) {
                $("#id_nivel_manual").val(data);
                $("#modal").modal('show');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("ManualesCreate013")");
                $("#modal").modal('hide');
            }
        });
    }

    function getLvlName(id) {
        $(".lvlName").load('@(Url.Action("GetLevel", "Manuales", null))' + '/' + id);

        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("GetContent", "Manuales"))',
            data: { id:id },
            success: function (data) {
                var jsonData = JSON.parse(data);

                var text = $("<div/>").html(jsonData.contenido).text();
                if (jsonData.tieneImagen) {
                    $("#imgContainer").attr("src", imgURL + id + "&idr=" + new Date().getTime());
                    $(".imgDisplay").attr("hidden", false);
                } else {
                    $(".imgDisplay").attr("hidden", true);
                }

                $("#ds_contenido_manual").val(text);
                $("#modal").modal('show');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.errpr("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                $("#modal").modal('hide');
            }
        });
    }


    function disAbleForm(op) {
        if (op == 0) {
            $('#form1 input,textarea').prop('disabled', true);
        }
        if (op == 1) {
            $('#form1 input,textarea').prop('disabled', false);
        }
    }

    function intFields() {
        $("#id_contenido_manual_padre").val("");  //valor del nodo padre cuando agregamos o editamos
        $("#id_contenido_manual").val("");        //En caso de que se esté editando el nodo
        $("#id_nivel_manual").val("");
        $("#cl_contenido_manual").val("");
        $("#ds_contenido_manual").val("");
        $("#errorP").html('');          //aqui se imprimen los errores
        $("#nb_archivo").val('');
        $("#archivo").val('');
        $("#partialModal").html("");
        $("#form1").show();             //Este es el formulario para trabajar
    }

    function canAssignSps(id) {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("CanEdit", "Manuales"))',
            data: {id:id, UserID:UserID},
                success: function (data) {
                    if (data == "1") AssignSps(id);
                    else toastr.warning("@Strings.getMSG("ManualesCreate011")");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
    }

    function AssignSps(id) {
        $("#gridModalLabel").html("@Strings.getMSG("btn002")");
        intFields();
        $("#form1").hide();

        $("#partialModal").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>')

        $("#partialModal").load('@(Url.Action("AssignSP", "Manuales",null))?id=' + id);

        $("#modal").modal('show');
    }

    function AssignU(id) {
        $("#gridModalLabel").html("@Strings.getMSG("btn003")");
        intFields();
        $("#form1").hide();

        $("#partialModal").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>')

        $("#partialModal").load('@(Url.Action("AssignU", "Manuales",null))?id=' + id);

        $("#modal").modal('show');
    }

    function showAddForm(id) {



        $("#gridModalLabel").html("@Strings.getMSG("Agregar") <span class='lvlName'><span/>");
        getNextLvlName(id);
        intFields();
        $("#id_contenido_manual_padre").val(id);

        disAbleForm(1);
        $(".editNode").hide();
        $(".deleteNode").hide();
        $(".createNode").show();
    }

    function canEdit(id) {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("CanEdit", "Manuales"))',
            data: {id:id, UserID:UserID},
                success: function (data) {
                    if (data == "1") showEditForm(id);
                    else toastr.warning("@Strings.getMSG("ManualesCreate011")");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
    }

    var dataNode;

    function showEditForm(id) {
        $("#gridModalLabel").html("@Strings.getMSG("Editar") <span class='lvlName'><span/>");

        dataNode = chart.get(id);

        intFields();
        $("#id_contenido_manual").val(id);
        $("#cl_contenido_manual").val(dataNode["Nombre"]);
        getLvlName(id);


        disAbleForm(1);
        $(".createNode").hide();
        $(".deleteNode").hide();
        $(".editNode").show();
    }

    function showDeleteForm(id) {
        $("#gridModalLabel").html("@Strings.getMSG("Borrar") <span class='lvlName'><span/>");

        var dataNode = chart.get(id);

        var pid = dataNode["pid"];
        if (pid == "") {
            toastr.error("@Strings.getMSG("ManualesCreate010")");
            return;
        }


        intFields();
        $("#id").val(id);
        $("#cl_contenido_manual").val(dataNode["Nombre"]);
        getLvlName(id);

        $("#errorP").html("@Strings.getMSG("ManualesEdit007")");


        disAbleForm(0);
        $(".createNode").hide();
        $(".editNode").hide();
        $(".deleteNode").show();
    }

    function crearP() {
        var error = Validar();
        if (error != "") {
            $("#errorP").html(error);
        } else {

            var formElement = document.getElementById("form1");
            var formData = new FormData(formElement);

            $.ajax({
                dataType: "html",
                type: "post",
                url: '@(Url.Action("AddSoon", "Manuales"))',
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,   // tell jQuery not to set contentType
                success: function (data) {
                    $("#contenedor1").html(data);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
            $("#modal").modal('hide');
        }
    }

    function editarP() {
        var error = Validar();
        if (error != "") {
            $("#errorP").html(error);
        } else {


            var formElement = document.getElementById("form1");
            var formData = new FormData(formElement);

            console.log(formData);

            $.ajax({
                dataType: "html",
                type: "post",
                //contentType: 'multipart/form-data',
                url: '@(Url.Action("EditContent", "Manuales"))',
                //data: $("#form1").serialize(),
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,   // tell jQuery not to set contentType
                success: function (data) {
                    //dataNode.Nombre = $("#cl_contenido_manual").val();
                    //chart.update(dataNode);
                    //chart.updateNode(dataNode);

                    $("#contenedor1").html(data);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
                }
            });
            $("#modal").modal('hide');
        }
    }

    function borrarP() {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("DeleteContent", "Manuales"))',
            data: $("#form2").serialize(),
            success: function (data) {
                $("#contenedor1").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
            }
        });

        $("#modal").modal('hide');
    }

    function saveSps() {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("AssignSP", "Manuales"))',
            data: $("#formAux").serialize(),
            success: function (data) {
                toastr.success("@Strings.getMSG("ManualesCreate009")");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
            }
        });
        $("#modal").modal('hide');
    }

    function saveU() {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("AssignU", "Manuales"))',
            data: $("#formAux").serialize(),
            success: function (data) {
                toastr.success("@Strings.getMSG("ManualesCreate008")");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
            }
        });
        $("#modal").modal('hide');
    }

    function move(id, LoR) {

        var dataNode = chart.get(id);

        var pid = dataNode["pid"];
        if (pid == "") {
            toastr.info("@Strings.getMSG("ManualesCreate007")");
            return;
        }

        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("MoveContent", "Manuales"))',
            data: {id:id,LoR:LoR},
            success: function (data) {
                $("#contenedor1").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("AuditoriaEditSeguimientoObservaciones009")");
            }
        });
    }

    function Validar() {
        var error = "";

        var nombre = $("#cl_contenido_manual").val();

        if (nombre == "" || nombre== null) {
            if (error != "") error += "<br/>";
            error += "@Strings.getMSG("CanalRiesgoOperacionalCreate006")";
        } else {
            if (nombre.length > 300) {
                if (error != "") error += "<br/>";
                error += "@Strings.getMSG("PuestoIndex006")";
            }
        }

        var descripción = $("#ds_contenido_manual").val();

        if (descripción == "" || descripción == null) {
            if (error != "") error += "<br/>";
            error += "@Strings.getMSG("ManualesEdit001")";
        }

        return error;
    }

    function GetPDF(id) {
        $("#menuModal .bodyContent").html('<span id="n"><embed src="@Url.Action("GetPDF","Manuales",null)/' + id + '" width="100%" height="700"></span>');
        $("#menuModal .HeadLabel").html("@Strings.getMSG("ManualesEdit008")");

        $("#menuModal").modal('show');
    }

</script>


<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="@Strings.getMSG("Aviso")" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <center>
                    <h2 class="modal-title" id="gridModalLabel" style="color: #fff;"></h2>
                </center>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
                <div id="partialModal"></div>
                <form class="form-horizontal" id="form1">
                    @Html.AntiForgeryToken()
                    <input type="text" id="id_contenido_manual" name="id_contenido_manual" hidden>
                    <input type="text" id="id_contenido_manual_padre" name="id_contenido_manual_padre" hidden>
                    <input type="text" id="id_nivel_manual" name="id_nivel_manual" hidden>

                    <div class="row">
                        <div class="col-xs-3">@Strings.getMSG("Nombre")</div>
                        <div class="col-xs-8">@Html.TextArea("cl_contenido_manual", new { @class = "form-control", @rows = "2", @title = Strings.getMSG("Atención"), data_trigger = "hover", data_toggle = "popover", data_content = Strings.getMSG("ManualesEdit002") })</div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-xs-3">@Strings.getMSG("NotificationEdit003")</div>
                        <div class="col-xs-8">@Html.TextArea("ds_contenido_manual", new { @class = "form-control", @rows = "5", @title = Strings.getMSG("Atención"), data_trigger = "hover", data_toggle = "popover", data_content = Strings.getMSG("ManualesEdit003")})</div>
                    </div>
                    <br />
                    <div class="row createNode editNode">
                        <div class="col-xs-3">@Strings.getMSG("Imagen")</div>
                        <div class="col-xs-8">
                            <div class="input-group">
                                <input type="text" id="nb_archivo" class="form-control text-box single-line valid" readonly="readonly">
                                <div class="input-group-btn">
                                    <label class="btn btn-default btn-file">
                                        @Strings.getMSG("Examinar") <input type="file" id="archivo" name="archivo" style="display: none;" accept="image/jpeg,image/gif,image/png">
                                    </label>
                                    <button type="button" onclick='$("#nb_archivo").val(""); $("#archivo").val("");' class="btn btn-default" title="@Strings.getMSG("RiesgoCreate119")">
                                        <i class="glyphicon glyphicon-remove"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <br />
                    <div class="row imgDisplay" hidden>
                        <div class="col-xs-12">
                            <img id="imgContainer" src="" width="100%" />
                        </div>
                    </div>
                    <br />

                    <input type="button" class="btn btn-primary createNode" value="@Strings.getMSG("Guardar")" onclick="crearP()" hidden />
                    <input type="button" class="btn btn-primary editNode" value="@Strings.getMSG("Guardar")" onclick="editarP()" hidden />
                    <button type="button" class="btn btn-default deleteNode" onclick="borrarP()" hidden>@Strings.getMSG("Borrar")</button>
                </form>
            </div>
            <div class="modal-footer">
                <div id="errorP" class="pull-left" style="color:indianred;">Hay un error</div>
                <button type="button" class="btn btn-default" data-dismiss="modal">@Strings.getMSG("Cancelar")</button>
            </div>
        </div>
    </div>
</div>



<form id="form2" hidden>
    @Html.AntiForgeryToken()
    <input id="id" name="id" hidden />
</form>

<h2>@ViewBag.Title</h2>

<br />
@Html.ActionLink(Strings.getMSG("Regresar"), "Index", null, new { @class = "btn btn-default" })
<input type="button" value="@Strings.getMSG("Previsualizar")" class="btn btn-primary" onclick="GetPDF(@ViewBag.id)" />
<br />
<br />


<div class="jumbotron well">
    <div style="width:100%; height:700px;" id="orgchart"></div>

    <script type="text/javascript">
        var chart;
        $(document).ready(function () {
            var EncData2 = @Html.Raw(ViewBag.JsonData);

            for (var i = 0; i < EncData2.length; i++) {
                var node = EncData2[i];
                switch (node.canEdit) {
                    case "0":
                        node.tags = ["noPermission"];
                        break;
                }
            }

            chart = new OrgChart(document.getElementById("orgchart"), {
                collapse: {
                    level: 3
                },
                menu: {
                    svg: { text: "Export SVG" },
                    csv: { text: "Export CSV" }
                },
                nodeMenu: {

                    @if(ViewBag.su == 1)
                    {
                        @:addP: {
                        @:icon: "<i class='fa fa-plus'></i>",
                        @:text: "@Strings.getMSG("btn001")",
                        @:onClick: showAddForm
                        @:},
                    }

                    editP: {
                        icon: "<i class='fa fa-pencil'></i>",
                        text: "@Strings.getMSG("Editar")",
                        onClick: canEdit
                    },

                    @if(ViewBag.su == 1)
                    {
                        @:deleteP: {
                        @:icon: "<i class='fa fa-trash'></i>",
                        @:text: "@Strings.getMSG("Borrar")",
                        @:onClick: showDeleteForm
                        @:},
                    }

                    deleteImgP: {
                        icon: "<i class='fa fa-picture-o'></i>",
                        text: "@Strings.getMSG("Borrar imagen")",
                        onClick: canDeleteImg
                    },

                    assignSP: {
                        icon: "<i class='fa fa-link'></i>",
                        text: "@Strings.getMSG("btn002")",
                        onClick: canAssignSps
                    },

                    @if(ViewBag.su == 1)
                    {
                        @:assignU:
                        @:{
                        @:    icon: "<i class='fa fa-group'></i>",
                        @:text: "@Strings.getMSG("btn003")",
                        @:onClick: AssignU
                        @:    },
                    }

                    moveL: {
                        icon: "<i class='fa fa-arrow-left'></i>",
                        text: "@Strings.getMSG("btn004")",
                        onClick: canMoveL
                    },
                    moveR: {
                        icon: "<i class='fa fa-arrow-right'></i>",
                        text: "@Strings.getMSG("btn005")",
                        onClick: canMoveR
                    }
                },
                toolbar: true,
                template: "ula",
                orderBy: "noOrden",
                nodeBinding: {
                    field_0: "Nombre",
                    field_1: "Clave",
                    field_2: "Descripcion",
                },
                nodes: EncData2
            });


            $("#archivo").change(function () {
                var filename = $("#archivo").val();
                $("#nb_archivo").val(filename);
                if (filename !== "") {
                    $("#submit").removeAttr("disabled");
                } else {
                    $("#submit").attr("disabled", "disabled");
                }
            });
        });
    </script>
</div>

<div id="contenedor1"></div>

