@model SCIRA.Models.c_entidad
@using SCIRA.Utilidades;
@using SCIRA.Models;

@{
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = "Incidencias detectadas";

    c_periodo_certificacion periodo = ViewBag.periodo;


    string certEntidad = (@Strings.getMSG("CertificacionInforme004"));
    var certEn = Model.k_certificacion_estructura.FirstOrDefault(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion);

    if(certEn != null)
    {
        certEntidad = certEn.resultado ? (@Strings.getMSG("CertificacionInforme034")) : (@Strings.getMSG("CertificacionInforme035"));
    }

    //Encontrar incidencias detectadas en los controles
    List<k_incidencia> incidencias = new List<k_incidencia>();

    foreach(var mp in Model.c_macro_proceso)
    {
        foreach (var pr in mp.c_proceso)
        {
            foreach (var sp in pr.c_sub_proceso)
            {
                foreach(var ctrl in sp.k_control)
                {
                    var certCTRL = ctrl.k_certificacion_control.FirstOrDefault(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion);
                    if(certCTRL != null) //Si existe la certificación, buscar una incidencia
                    {
                        var incidencia = certCTRL.k_incidencia.FirstOrDefault();
                        if (incidencia != null)
                        {
                            incidencias.Add(incidencia);
                        }
                    }
                }
            }
        }
    }


}

<style>
    .card-header {
        font-size: 1.7rem;
        font-weight: bold;
    }

    .card-body {
        font-size: 1.6rem;
    }
</style>

<script>
    var modalOptions = {
        title: "@Strings.getMSG("AuditoriaCreateUniversoAuditableCreate013")",
        size: "xl",
        show: true,
        loadUrl: "@(Url.Action("SelectorPeriodo"))"
    }

    function selectorPeriodo(id) {
        menuModal.initModal(modalOptions);
    }

    var Url = "@(Url.Action("UniversoCertificado"))?id=@(Model.id_entidad)&id_periodo=";

    function goToPeriod(id) {
        window.location.href = Url + id;
    }
</script>



<h2><span class="catalogName">@Strings.getMSG("Incidencias Detectadas")</span></h2>

<h3>@Strings.getMSG("CertificacionInforme036") @Model.nb_entidad @certEntidad</h3>

@Html.ActionLink(Strings.getMSG("Regresar"), "Index", new { id = periodo.id_periodo_certificacion }, new { @class = "btn btn-default" })

<div class="row" style="margin-top: 20px;">
    <div class="card-group" style="margin:0 0 20px 0">
        <div class="card hover" onclick="selectorPeriodo();">
            <div class="card-header text-center">@Strings.getMSG("CertificacionesEntidad001")</div>
            <div class="card-body text-center">
                @if (periodo != null)
                {
                    @(periodo.nb_periodo_certificacion + " - " + periodo.anio)
                }
                else
                {
                    @("N/A")
                }
            </div>
        </div>
    </div>
</div>

<table id="results" class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>@Strings.getMSG("MP")</th>
            <th>@Strings.getMSG("P")</th>
            <th>@Strings.getMSG("SP")</th>
            <th>@Strings.getMSG("RiesgoCreate084")</th>
            <th>@Strings.getMSG("ControlDelete003")</th>
            <th>@Strings.getMSG("CertificacionInforme009")</th>
            <th>@Strings.getMSG("lyPIncidenciasIndex001")</th>
            <th>@Strings.getMSG("BDEICreate005")</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in incidencias)
        {
            string estatus = !item.requiere_plan ? @Strings.getMSG("CertificacionInforme037") : @Strings.getMSG("CertificacionInforme038") ;

            //item.r_respuesta.Count() == 0 ? "Pendiente" : "Atendida";
            var control = item.k_certificacion_control.k_control;
            var sp = control.c_sub_proceso;
            var pr = sp.c_proceso;
            var mp = pr.c_macro_proceso;

            <tr>
                <td>@mp.cl_macro_proceso - @mp.nb_macro_proceso</td>
                <td>@pr.cl_proceso - @pr.nb_proceso</td>
                <td>@sp.cl_sub_proceso - @sp.nb_sub_proceso</td>
                <td>@control.relacion_control</td>
                <td>@control.actividad_control</td>
                <td>@item.ds_incidencia</td>
                <td>@item.c_clasificacion_incidencia.nb_clasificacion_incidencia</td>
                <td>@estatus</td>
            </tr>
        }
    </tbody>
</table>
