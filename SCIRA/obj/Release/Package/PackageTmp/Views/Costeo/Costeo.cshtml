@model SCIRA.Models.c_sub_proceso
@using System.Reflection;
@using SCIRA.Models;

@{
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = "Costeo";
}


<link href="~/Content/font-awesome.min.css" rel="stylesheet" />
<link href="~/Content/base.css" rel="stylesheet" />
<link href="~/Content/bootstrap-datetimepicker.css" rel="stylesheet" />

<script type="text/javascript" src="~/Scripts/moment-with-locales.js"></script>
<script type="text/javascript" src="~/Scripts/bootstrap-datetimepicker.js"></script>
<script type="text/javascript" src="~/Scripts/sharedScripts.js"></script>

<script>
        $("document").ready(function () {
            @foreach (var item in Model.c_area_costeo_sub_proceso)
            {
            @:var id = "@item.id_area_costeo";
            @:$("#a" + id).val(cppc("@item.pr_costeo"));
            }
        });
</script>

<h3>Sub Proceso @Model.cl_sub_proceso @Model.nb_sub_proceso - Costeo</h3>

<ul class="nav nav-tabs">
    <li><a href="#generales" data-toggle="tab"><h4>Datos Generales</h4></a></li>
    <li class="active"><a href="#participantes" data-toggle="tab"><h4>Participantes</h4></a></li>
    <li><a href="#costeo" id="Cost" data-toggle="tab"><h4>Actividades de Costeo</h4></a></li>
</ul>

<div id="myTabContent" class="tab-content">

    <div class="tab-pane" id="generales">
        <br />
        <div class="form-horizontal">


            <div class="form-group">
                <label class="control-label col-md-2">Entidad</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_proceso.c_macro_proceso.c_entidad.nb_entidad)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Macro Proceso</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_proceso.c_macro_proceso.nb_macro_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Proceso</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_proceso.nb_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Clave Sub Proceso</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.cl_sub_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Sub Proceso</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.nb_sub_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Descripción</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.ds_sub_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Responsable de Sub Proceso</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_usuario.nb_usuario)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Código de Manual</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.cl_manual)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Sub Proceso Anterior</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.cl_sp_anterior)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Sub Proceso Siguiente</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.cl_sp_siguiente)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Tipología</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_tipologia_sub_proceso.nb_tipologia_sub_proceso)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Etapa</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_etapa != null ? Model.c_etapa.nb_etapa : "N/A")" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Sub Etapa</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.c_sub_etapa != null ? Model.c_sub_etapa.nb_sub_etapa : "N/A")" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Áreas Relacionadas</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.ds_areas_involucradas)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Aplicaciones Relacionadas</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.ds_aplicaciones_relacionadas)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Nombre de archivo de Narrativa</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.nb_archivo_manual)" disabled="">
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2">Nombre de archivo de Flujo</label>
                <div class="col-md-10">
                    <input class="form-control" type="text" value="@(Model.nb_archivo_flujo)" disabled="">
                </div>
            </div>

            @{
                List<c_meta_campo> lista = ViewBag.CamposExtraSubProceso;

                Type m_tipo = null;
                PropertyInfo[] m_propiedades = null;
                m_tipo = Model.GetType();
                m_propiedades = m_tipo.GetProperties();

                for (int i = 0; i < 20; i++)
                {
                    var item = lista.ElementAt(i);
                    if (item.es_visible)
                    {
                        var prop = m_propiedades.Where(p => p.Name == string.Format("campo{0:00}", i + 1)).First();

                        
                    <div class="form-group">
                        <label class="control-label col-md-2">@item.nb_campo</label>
                        <div class="col-md-10">

                        @if (item.cl_tipo_campo == "t")
                        {
                            <input class="form-control" type="text" value="@prop.GetValue(Model,null)" disabled>
                        }
                        else if (item.cl_tipo_campo == "a")
                        {
                            <textarea class="form-control" rows="5" disabled>@prop.GetValue(Model,null)</textarea>
                        }
                        else if (item.cl_tipo_campo == "n")
                        {
                           
                            <input class="form-control" type="number" value="@prop.GetValue(Model,null)" disabled>
                        }
                        </div>
                    </div>
                    }
                }
            }


            <div class="form-group">
                <div class="col-md-10">
                    @Html.ActionLink("Regresar", "Index", "SubProceso", new { @class = "btn btn-default" })
                    <br>
                </div>
            </div>

        </div>
    </div>

    <div class="tab-pane fade active in" id="participantes">
        <br />

        <table id="results" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>
                        Nombre del Participante
                    </th>
                    <th>
                        Puesto
                    </th>
                    <th>
                        Tiempo Invertido (Minutos)
                    </th>
                    <th></th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model.c_usuario_sub_proceso)
                {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.c_usuario.nb_usuario)
                        </td>
                        <td>
                            @SCIRA.Utilidades.Utilidades.PuestoUsuario(item.id_usuario)
                        </td>
                        <td>
                            <center>
                                @Html.EditorFor(modelItem => item.tiempo_sub_proceso, new { htmlAttributes = new { @class = "form-control s1", @id = "u" + @item.id_usuario } })
                            </center>
                        </td>
                        <td>
                            <a href="#" onclick="TiempoUsuario(@item.id_usuario)">
                                <i class="fa fa-floppy-o fa-lg" title="Guardar"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="form-group">
            <div class="col-md-10">
                @Html.ActionLink("Regresar", "Index", "SubProceso", new { @class = "btn btn-default" })
                <br>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="costeo">
        <br />

        <table id="results2" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>
                        Actividad de Costeo
                    </th>
                    <th>
                        Porcentaje
                    </th>
                    <th></th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model.c_area_costeo_sub_proceso)
                {
                    <tr>
                        <td>
                            @item.c_area_costeo.cl_area_costeo - @item.c_area_costeo.nb_area_costeo
                        </td>
                        <td>
                            <center>
                                @Html.EditorFor(modelItem => item.pr_costeo, new { htmlAttributes = new { @class = "form-control s1", @id = "a" + @item.id_area_costeo, @type = "number" } })
                            </center>
                        </td>
                        <td>
                            <a href="#" onclick="PorcentajeAreaCosteo(@item.id_area_costeo)">
                                <i class="fa fa-floppy-o fa-lg" title="Guardar"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>


        <div class="form-group">
            <div class="col-md-10">
                @Html.ActionLink("Regresar", "Index", "SubProceso", new { @class = "btn btn-default" })
                <br>
            </div>
        </div>

    </div>
</div>

@using (Html.BeginForm("TiempoParticipante", "SubProceso", FormMethod.Post, new { @id = "formU" }))
{
    @Html.AntiForgeryToken()
    <input type="hidden" id="id_sub_proceso" name="id_sub_proceso">
    <input type="hidden" id="id_usuario" name="id_usuario">
    <input type="hidden" id="tiempo_sub_proceso" name="tiempo_sub_proceso">
}

@using (Html.BeginForm("PorcentajeAreaCosteo", "SubProceso", FormMethod.Post, new { @id = "formA" }))
{
    @Html.AntiForgeryToken()
    <input type="hidden" id="id_sub_proceso2" name="id_sub_proceso">
    <input type="hidden" id="id_area_costeo" name="id_area_costeo">
    <input type="hidden" id="pr_costeo" name="pr_costeo">
}

<script>
    function TiempoUsuario(id) {
        var id_us = id;
        var id_sp= @Model.id_sub_proceso;
        var tiempo_usuario = $("#u" + id).val();
        if (tiempo_usuario == null) tiempo_usuario = 0;
        if (tiempo_usuario == 0) tiempo_usuario = 0;

        var valid = isValidNumber(tiempo_usuario);

        if (valid) {
            url = '@(Url.Action("TiempoParticipante", "SubProceso"))';

            $.ajax({
                dataType: "html",
                type: "post",
                cache: false,
                url: url,
                data: { id_sp, id_us, tiempo_usuario},
                success: function (data) {
                    var obj = JSON.parse(data);
                    $("#u" + obj.id).val(obj.val);
                    toastr.success("Se han guardado los cambios con éxito.")
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("Algo salió mal, por favor intente de nuevo.");
                }
            });
        }
    }

    function PorcentajeAreaCosteo(id) {
        var id_ac = id;
        var id_sp = @Model.id_sub_proceso;
        var pr_costeo = $("#a" + id).val();
        if (pr_costeo == null) pr_costeo = 0;
        if (pr_costeo == 0) pr_costeo = 0;

        var valid = isValidNumber(pr_costeo);
        valid = validCosteo(pr_costeo) && valid;

        if (valid) {
            url = '@(Url.Action("PorcentajeAreaCosteo", "SubProceso"))';

            $.ajax({
                dataType: "html",
                type: "post",
                cache: false,
                url: url,
                data: { id_sp, id_ac, pr_costeo},
                success: function (data) {
                    var obj = JSON.parse(data);
                    if (obj.error != undefined) {
                        toastr.error(obj.error);
                        $("#a" + obj.id).val(obj.originalVal);
                    } else {
                        toastr.success("Se han guardado los cambios con éxito.")
                        $("#a" + obj.id).val(obj.val);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("Algo salió mal, por favor intente de nuevo.");
                }
            });
        }
    }

    function isValidNumber(number) {
        var bool = true;
        if (isNaN(number)) bool = false;
        if (number < 0) {
            bool = false;
            toastr.error("El valor no puede ser menor a 0");
        }
        return bool;
    }

    function validCosteo(number){
        var bool = true;
        if (number > 100) {
            bool = false;
            toastr.error("El valor no puede ser mayor a 100%")
        }

        return bool;
    }



    jQuery('.s1').on('keypress', function (e) {
        if (e.keyCode == 101 || e.keyCode == 45 || e.keyCode == 43 || e.keyCode == 44 || e.keyCode == 47) {
            return false;
        }
        soloNumeros(e.keyCode);
    });

    function soloNumeros(e) {
        var key = window.Event ? e.which : e.keyCode
        return (key >= 48 && key <= 57)
    }

</script>