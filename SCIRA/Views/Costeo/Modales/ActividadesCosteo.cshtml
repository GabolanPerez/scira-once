@model SCIRA.Models.c_sub_proceso
@using SCIRA.Utilidades
@using SCIRA.Models
@using System.Reflection;


<script>

    var lvl2URL = '@(Url.Action("LVL2","Costeo"))';

    $(document).ready(function () {
        menuModal.setTitle('@Strings.getMSG("GraphicsCosteoIndex008") @Model.cl_sub_proceso');
        initTables("#menuModal",false);
    });

    @foreach (var item in Model.c_area_costeo_sub_proceso)
    {
    @:var id = "@item.id_area_costeo";
    @:$("#a" + id).val(parseFloat(cppc("@item.pr_costeo")));
    }


    function PorcentajeAreaCosteo(id) {
        var id_ac = id;
        var id_sp = @Model.id_sub_proceso;
        var pr_costeo = $("#a" + id).val();
        if (pr_costeo == null) pr_costeo = 0;
        if (pr_costeo == 0) pr_costeo = 0;

        var valid = isValidNumber(pr_costeo);
        valid = validCosteo(pr_costeo) && valid;

        if (valid) {
            url = '@(Url.Action("PorcentajeAreaCosteo", "Costeo"))';

            $.ajax({
                dataType: "html",
                type: "post",
                cache: false,
                url: url,
                data: { id_sp, id_ac, pr_costeo},
                success: function (data) {
                    var obj = JSON.parse(data);
                    if (obj.error != undefined) {
                        toastr.error(obj.error);
                        $("#a" + obj.id).val(obj.originalVal);
                    } else {
                        toastr.success("Se han guardado los cambios con éxito.")
                        $("#a" + obj.id).val(obj.val);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    toastr.error("@Strings.getMSG("ActividadCosteoIndex009")");
                }
            });
        }
    }

    function isValidNumber(number) {
        var bool = true;
        if (isNaN(number)) bool = false;
        if (number < 0) {
            bool = false;
            toastr.error("El valor no puede ser menor a 0");
        }
        return bool;
    }

    function validCosteo(number){
        var bool = true;
        if (number > 100) {
            bool = false;
            toastr.error("El valor no puede ser mayor a 100%")
        }

        return bool;
    }

    function submitCosteo() {
        var sum = 0;

        $(".val").each(function () {
            var $this = $(this);
            var aux = parseFloat($this.val());

            if (isNaN(aux)) {
                $this.val(0);
                aux = 0;
            }

            sum = (aux + sum);
        })
        
        if (sum.toFixed(5) == 100) {
            executePost(
                '@Url.Action("PorcentajeAreaCosteo","Costeo")',
                'form1',
                "toastr.success('@Strings.getMSG("CosteoIndex006")')",
                "toastr.error('@Strings.getMSG("AvisoError003")')"
            );
        } else {
            if (sum < 100) {
                toastr.error("@Strings.getMSG("AvisoError001") "+parseFloat(sum.toFixed(5))+"%) @Strings.getMSG("CosteoIndex007")");
            } else if (sum > 100) {
                toastr.error("@Strings.getMSG("AvisoError001")"+parseFloat(sum.toFixed(5))+"% @Strings.getMSG("AvisoError002")");
            }
        }

    }

    function showLVL2(id_ac) {
        $("#f2i2").val(id_ac);

        var data = $("#form2").serialize();

        menuModal.bodyLoad(lvl2URL, null, data);
    }

</script>


<button class="btn btn-default" onclick="menuModal.bodyLoad('@Url.Action("Details","Costeo")/@Model.id_sub_proceso')">@Strings.getMSG("Regresar")</button>
<br />
<br />

<form id="form1">
    <table class="results table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>
                    @Strings.getMSG("Menu011")
                </th>
                <th>
                    @Strings.getMSG("RiesgoResidualConfigIndex020")
                </th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @foreach (var item in Model.c_area_costeo_sub_proceso)
            {
                <tr>
                    <td>
                        @item.c_area_costeo.cl_area_costeo - @item.c_area_costeo.nb_area_costeo
                    </td>
                    <td>
                        <center>
                            <input type="number" class="form-control S1 val" id="a@(item.id_area_costeo)" value="   " name="vals[]" />
                            <input type="hidden" value="@item.id_area_costeo" name="ids_areas[]" />
                        </center>
                    </td>
                    <td>
                        <center>
                            <a onclick="showLVL2(@item.id_area_costeo)">
                                <i class="fa fa-navicon" title="@Strings.getMSG("Ver Detalle")"></i>
                            </a>
                        </center>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <input type="hidden" value="@Model.id_sub_proceso" name="id_sp" />
</form>

<input type="button" class="btn btn-primary pull-right" value="@Strings.getMSG("Guardar")" onclick="submitCosteo();" />


<br /><br />


<form id="form2" >
    <input type="hidden" id="f2i1" name="id_sp" value="@Model.id_sub_proceso"/>
    <input type="hidden" id="f2i2" name="id_ac"/>
</form>