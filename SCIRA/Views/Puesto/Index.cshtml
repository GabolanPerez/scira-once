@using SCIRA.Utilidades
@{
    /**/

    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = "Organigrama de Puestos";

    string data = ViewBag.data;
}

<link href="~/Content/jquery.orgchart.css" rel="stylesheet" />
<link href="~/Content/font-awesome.min.css" rel="stylesheet" />
<link href="~/Content/Extras.css" rel="stylesheet" />

<script src="~/Scripts/BootstrapMenu.min.js"></script>
<script src="~/Scripts/jquery.orgchart.js"></script>
<script src="~/Scripts/sharedScripts.js"></script>

<script src="~/Scripts/Certificacion.js"></script>
<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-select.js"></script>

<script>
    var oc;


    $(document).ready(function () {
        var menu = new BootstrapMenu('.node', {
            fetchElementData: function ($node) {
                var id = $node.attr('id');
                return id;
            },
            actions: [{
                name: 'Agregar',
                iconClass: 'fa-plus',
                onClick: function (id) {
                    //toastr.info("Se agregará un nodo Hijo al puesto con id: " + id);
                    showAddForm(id);
                }
            }, {
                name: 'Editar',
                iconClass: 'fa-pencil',
                onClick: function (id) {
                    //toastr.info("Se editará este nodo!");
                    showEditForm(id);
                }
            }, {
                name: 'Borrar',
                iconClass: 'fa-trash',
                onClick: function (id) {
                    //toastr.info("Se eliminó el nodo");
                    showDeleteForm(id);
                }
            }, {
                name: 'Asignar Usuarios',
                iconClass: 'fa-users',
                onClick: function (id) {
                    //toastr.info("Se eliminó el nodo");
                    AssignUsers(id);
                }
            }]
        });
    });

    function disAbleForm(op) {
        if (op == 0) {
            $('#form1 input').prop('disabled', true);
        }
        if (op == 1) {
            $('#form1 input').prop('disabled', false);
        }
    }

    function intFields() {
        $("#id_puesto_padre").val("");
        $("#id_puesto").val("");
        $("#cl_puesto").val("");
        $("#nb_puesto").val("");
        $("#errorP").html('');
        $("#partialModal").html("");
        $("#form1").show();
    }

    function AssignUsers(id) {
        $("#gridModalLabel").html("Asignar Usuarios");
        intFields();
        $("#form1").hide();

        $("#partialModal").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>')

        $("#partialModal").load('@(Url.Action("AssignUsers", "Puesto",null))?id=' + id);

        $("#modal").modal('show');
    }

    function showAddForm(id) {
        $("#gridModalLabel").html("Agregar Puesto");
        intFields();
        $("#id_puesto_padre").val(id);

        disAbleForm(1);
        $(".editNode").hide();
        $(".deleteNode").hide();
        $(".createNode").show();
        $("#modal").modal('show');
    }

    function showEditForm(id) {
        $("#gridModalLabel").html("Editar Puesto");
        var $puesto = $("#" + id);
        intFields();
        $("#id_puesto").val(id);
        $("#cl_puesto").val($puesto.find(".title").text());
        $("#nb_puesto").val($puesto.find(".content").text());

        disAbleForm(1);
        $(".createNode").hide();
        $(".deleteNode").hide();
        $(".editNode").show();
        $("#modal").modal('show');
    }

    function showDeleteForm(id) {
        $("#gridModalLabel").html("Borrar Puesto");
        var $puesto = $("#" + id);
        intFields();
        $("#id").val(id);
        $("#cl_puesto").val($puesto.find(".title").text());
        $("#nb_puesto").val($puesto.find(".content").text());
        $("#errorP").html("Al confirmar se borrará este puesto así como todos los nodos inferiores y los usuarios que tengan este puesto, quedarán sin puesto.");


        disAbleForm(0);
        $(".createNode").hide();
        $(".editNode").hide();
        $(".deleteNode").show();
        $("#modal").modal('show');
    }

    function crearP() {
        var error = Validar();
        if (error != "") {
            $("#errorP").html(error);
        } else {
            $.ajax({
                dataType: "html",
                type: "post",
                url: '@(Url.Action("Create", "Puesto"))',
                data: $("#form1").serialize(),
                success: function (data) {
                    $("#contenedor1").html(data);
                    $("#modal").modal('hide');
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    //alert("algo salio mal");
                }
            });
        }
    }

    function editarP() {
        var error = Validar();
        if (error != "") {
            $("#errorP").html(error);
        } else {
            $.ajax({
                dataType: "html",
                type: "post",
                url: '@(Url.Action("Edit", "Puesto"))',
                data: $("#form1").serialize(),
                success: function (data) {
                    $("#contenedor1").html(data);
                    $("#modal").modal('hide');
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    //alert("algo salio mal");
                }
            });
        }
    }

    function borrarP() {
            $.ajax({
                dataType: "html",
                type: "post",
                url: '@(Url.Action("Delete", "Puesto"))',
                data: $("#form2").serialize(),
                success: function (data) {
                    $("#contenedor1").html(data);
                    $("#modal").modal('hide');
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    //alert("algo salio mal");
                }
            });
    }

    function saveUsers() {
        $.ajax({
            dataType: "html",
            type: "post",
            url: '@(Url.Action("AssignUsers", "Puesto"))',
            data: $("#formAux").serialize(),
            success: function (data) {
                toastr.success("Los usuarios se asignaron con éxito.");
                $("#modal").modal('hide');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                //alert("algo salio mal");
            }
        });
    }

    function Validar() {
        var error = "";

        var nombre = $("#nb_puesto").val();

        if (nombre == "" || nombre== null) {
            if (error != "") error += "<br/>";
            error += "El nombre es un campo obligatorio.";
        } else {
            if (nombre.length > 256) {
                if (error != "") error += "<br/>";
                error += "La longitud máxima del nombre es de 256 caracteres.";
            }
        }
        return error;
    }

</script>


<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="Aviso" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <center>
                    <h2 class="modal-title" id="gridModalLabel" style="color: #fff;"></h2>
                </center>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
                <div id="partialModal"></div>
                <form class="form-horizontal" id="form1">
                    @Html.AntiForgeryToken()
                    <input type="text" id="id_puesto" name="id_puesto" hidden>
                    <input type="text" id="id_puesto_padre" name="id_puesto_padre" hidden>
                    <table>
                        <tbody>
                            <tr class="editNode deleteNode">
                                <td width="100">Clave</td>
                                <td width="200">
                                    <div class="input-group">
                                        <input class="form-control text-box single-line" data-val="true" data-val-required="La clave es un campo requerido." id="cl_puesto" name="cl_puesto" type="text" value="" readonly>
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-default" title="" data-toggle="popover" data-trigger="hover" data-content="La clave indica el nivel al que pertenece el puesto." data-original-title="Atención">
                                                <i class="glyphicon glyphicon-question-sign"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                                <td width="250"></td>
                            </tr>
                            <tr>
                                <td>Nombre</td>
                                <td>
                                    <div class="input-group">
                                        <input class="form-control text-box single-line" data-val="true" data-val-required="El nombre es un campo requerido." id="nb_puesto" name="nb_puesto" type="text" value="">
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-default" title="" data-toggle="popover" data-trigger="hover" data-content="Ingrese un nombre para el nuevo puesto." data-original-title="Atención">
                                                <i class="glyphicon glyphicon-question-sign"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                                <td width="250">
                                    <center>
                                        <input type="button" class="btn btn-primary createNode" value="Guardar" onclick="crearP()" hidden />
                                        <input type="button" class="btn btn-primary editNode" value="Guardar" onclick="editarP()" hidden />
                                        <button type="button" class="btn btn-default deleteNode" onclick="borrarP()" hidden>Borrar</button>
                                    </center>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <div id="errorP" class="pull-left" style="color:indianred;">Hay un error</div>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<form id="form2" hidden>
    @Html.AntiForgeryToken()
    <input id="id" name="id" hidden />
</form>

<h2>@ViewBag.Title</h2>

<div class="jumbotron well">
    <div id="chart-container"></div>

    <div id="contenedor1"></div>

    <script type="text/javascript">
        $(function () {

            var datascource = @Html.Raw(ViewBag.data);

            oc = $('#chart-container').orgchart({
                'data': datascource,
                'nodeContent': 'title'
            });

            /*oc.$chartContainer.on('click', '.node', function () {
                var $this = $(this);
                var id = $this.attr('id');

                alert(id);
            });*/
        });
    </script>
</div>


