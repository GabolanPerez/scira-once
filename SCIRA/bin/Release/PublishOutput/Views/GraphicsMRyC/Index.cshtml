@using SCIRA.Utilidades
@{

    ViewBag.Title = Strings.getMSG("GraphicsCosteoIndex009");
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
}
<script src="~/Scripts/chart.js"></script>
<script src="~/Scripts/graphics.js"></script>
<link href="~/Content/Extras.css" rel="stylesheet" />
<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-select.js"></script>
<script src="~/Scripts/MSInitialize.js"></script>
<link href="~/Content/bootstrap-toggle.min.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-toggle.min.js"></script>
<script src="~/Scripts/sharedScripts.js"></script>
<script>
    var options1 = {
        responsive: true,
        title: {
            display: true,
            text: 'title'
        }
    };

    var options2 = {
        title: {
            display: true,
            text: 'Chart.js Bar Chart - Stacked'
        },
        tooltips: {
            mode: 'index',
            intersect: false
        },
        responsive: true,
        scales: {
            xAxes: [{
                stacked: true,
            }],
            yAxes: [{
                stacked: true
            }]
        }
    };


    //Datos para la gráfica general
    var data0 = @Html.Raw(ViewBag.d0);
    var g0;
    var gr0;
    var tg0 = 'bar';

    var data1 = @Html.Raw(ViewBag.d1);
    var g1;
    var gr1;
    var tg1 = 'pie';

    var data2 = @Html.Raw(ViewBag.d2);
    var g2;
    var gr2;
    var tg2 = 'bar';

    var data3 = @Html.Raw(ViewBag.d3);
    var g3;
    var gr3;
    var tg3 = 'bar';

    //filtros para grafica general
    var entidades = [];
    var puestos = [];
    var usuarios = [];
    var niveles = [];
    var periodos = [];








    $(document).ready(function () {
        g0 = $("#g0");
        gr0 = buildChart(data0, tg0, "@Strings.getMSG("Menu077")", g0, options1);

        g1 = $("#g1");
        gr1 = buildChart(data1, tg1, '@Strings.getMSG("GraphicsMRyCIndex011")', g1, options1);

        g2 = $("#g2");
        gr2 = buildChart(data2, tg2, '@Strings.getMSG("Menu118")', g2, options2);

        g3 = $("#g3");
        gr3 = buildChart(data3, tg3, '@Strings.getMSG("GraphicsMRyCIndex016")', g3, options2);

        //funciones al hacer clic en los elementos de la gráica 0;
        document.getElementById("g0").onclick = function (evt) {
            var activePoints = gr0.getElementsAtEvent(evt);
            if (activePoints[0]) {
                var chartData = activePoints[0]['_chart'].config.data;
                var idx = activePoints[0]['_index'];
                //var label = chartData.labels[idx];
                //var value = chartData.datasets[0].data[idx];
                //var id = chartData.ids[idx];


                details(idx);
            }
        };

        document.getElementById("g1").onclick = function (evt) {
            var activePoints = gr1.getElementsAtEvent(evt);
            if (activePoints[0]) {
                var chartData = activePoints[0]['_chart'].config.data;
                var idx = activePoints[0]['_index'];
                var id = chartData.ids[idx];
                var label = chartData.labels[idx];

                detailsCrit(id, label);
            }
        };

        document.getElementById("g2").onclick = function (evt) {
            var activePoints = gr2.getElementsAtEvent(evt);
            var firstPoint = gr2.getDatasetAtEvent(evt);

            if (activePoints[0]) {
                var chartData = activePoints[0]['_chart'].config.data;
                var idx = activePoints[0]['_index'];

                var idDs = chartData.datasets[firstPoint[0]._datasetIndex].id; //Id de la barra (1 = Positivos,2 = negativos,3 = noCertificados)
                toastr.info(idDs);
                toastr.info(JSON.stringify(chartData.ids));
                var idPr = chartData.ids[idx];                                 //Id del periodo
                var label = chartData.labels[idx];

                detailsCert(idPr, idDs, label);
            }
        };

        document.getElementById("g3").onclick = function (evt) {
            var activePoints = gr3.getElementsAtEvent(evt);
            var firstPoint = gr3.getDatasetAtEvent(evt);

            if (activePoints[0]) {
                var chartData = activePoints[0]['_chart'].config.data;
                var idx = activePoints[0]['_index'];

                var idDs = chartData.datasets[firstPoint[0]._datasetIndex].id;  //Id de la criticidad_riesgo
                var crs = chartData.datasets[firstPoint[0]._datasetIndex].label;//Nombre de la criticidad_riesgo
                var idPr = chartData.ids[idx];                                  //Id del periodo
                var label = chartData.labels[idx];                              //Nombre del periodo

                detailsNCert(idPr, idDs, label,crs);
            }
        };

        $('.custom-picker').on('hide.bs.dropdown', function (e) {
            var b1 = false;
            var b2 = false;
            var b3 = false;
            var b4 = false;
            var b5 = false;

            var nentidades = $('#entidades').val();
            var npuestos = $('#puestos').val();
            var nusuarios = $('#usuarios').val();
            var nniveles = $('#niveles').val();
            var nperiodos = $('#periodos').val();


            if (nentidades != null) {
                nentidades.forEach(function (elemento) {
                    if (!entidades.includes(elemento)) {
                        b1 = true;
                    }
                });
                entidades.forEach(function (elemento) {
                    if (!nentidades.includes(elemento)) {
                        b1 = true;
                    }
                });
            } else {
                if (entidades.length != 0) {
                    b1 = true;
                }
                nentidades = [];
            }
            if (b1) {
                entidades = nentidades;
            }

            if (npuestos != null) {
                npuestos.forEach(function (elemento) {
                    if (!puestos.includes(elemento)) {
                        b2 = true;
                    }
                });
                puestos.forEach(function (elemento) {
                    if (!npuestos.includes(elemento)) {
                        b2 = true;
                    }
                });
            } else {
                if (puestos.length != 0) {
                    b2 = true;
                }
                npuestos = [];
            }
            if (b2) {
                puestos = npuestos;
            }

            if (nusuarios != null) {
                nusuarios.forEach(function (elemento) {
                    if (!usuarios.includes(elemento)) {
                        b3 = true;
                    }
                });
                usuarios.forEach(function (elemento) {
                    if (!nusuarios.includes(elemento)) {
                        b3 = true;
                    }
                });
            } else {
                if (usuarios.length != 0) {
                    b3 = true;
                }
                nusuarios = [];
            }
            if (b3) {
                usuarios = nusuarios;
            }

            if (nniveles != null) {
                nniveles.forEach(function (elemento) {
                    if (!niveles.includes(elemento)) {
                        b4 = true;
                    }
                });
                niveles.forEach(function (elemento) {
                    if (!nniveles.includes(elemento)) {
                        b4 = true;
                    }
                });
            } else {
                if (niveles.length != 0) {
                    b4 = true;
                }
                nniveles = [];
            }
            if (b4) {
                niveles = nniveles;
            }


            if (nperiodos != null) {
                nperiodos.forEach(function (elemento) {
                    if (!periodos.includes(elemento)) {
                        b5 = true;
                    }
                });
                periodos.forEach(function (elemento) {
                    if (!nperiodos.includes(elemento)) {
                        b5 = true;
                    }
                });
            } else {
                if (periodos.length != 0) {
                    b5 = true;
                }
                nperiodos = [];
            }
            if (b5) {
                periodos = nperiodos;
            }


            if (b1 || b2 || b3 || b4 || b5) loadFilters();
        });

    });

    function details(id) {
        if (id == 0) {
            $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex022")</center>");
            $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
            loadTables(1);
        }
        if (id == 1) {
            $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex023")</center>");
            $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
            loadTables(2);
        }
        if (id == 2) {
            $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex024")</center>");
            $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
            loadTables(3);
        }
        if (id == 3) {
            $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex025")</center>");
            $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
            loadTables(4);
        }
        if (id == 4) {
            $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex021")</center>");
            $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
            loadTables(5);
        }
        $("#aviso").modal("show");
    }


    $(function () {

        $('.chbx').change(function () {
            loadFilters();
        })
    });

    function loadFilters() {
        $.ajax({
            dataType: "html",
            type: "post",
            cache: false,
            url: '@(Url.Action("loadFilters", "GraphicsMRyC"))',
            data: $("#form1").serialize(),
            success: function (data) {
                $("#contenedor1").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("GraphicsMRyCIndex020")");
            }
        });
    }

    function loadTables(type) {
        var url = "";
        if (type == 1) {
            url = '@(Url.Action("DetailsMP", "GraphicsMRyC"))';
        }
        if (type == 2) {
            url = '@(Url.Action("DetailsP", "GraphicsMRyC"))';
        }
        if (type == 3) {
            url = '@(Url.Action("DetailsSP", "GraphicsMRyC"))';
        }
        if (type == 4) {
            url = '@(Url.Action("DetailsR", "GraphicsMRyC"))';
        }
        if (type == 5) {
            url = '@(Url.Action("DetailsC", "GraphicsMRyC"))';
        }


        $.ajax({
            dataType: "html",
            type: "post",
            cache: false,
            url: url,
            data: $("#form1").serialize(),
            success: function (data) {
                $("#modalB").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("GraphicsMRyCIndex020")");
            }
        });
    }

    function detailsCrit(id, label) {
        $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex013") '" + label + "' </center>");
        $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
        $("#id_crit").val(id);
        $("#aviso").modal("show");
        $.ajax({
            dataType: "html",
            type: "post",
            cache: false,
            url: '@(Url.Action("DetailsCrit", "GraphicsMRyC"))',
            data: $("#form1").serialize(),
            success: function (data) {
                $("#modalB").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("GraphicsMRyCIndex020")");
                $("#aviso").modal("hide");
            }
        });
    }

    function detailsCert(idP, idB, label) {
        var pnnc = "";
        if (idB == 1) pnnc = "@Strings.getMSG("GraphicsMRyCIndex026")";
        if (idB == 2) pnnc = "@Strings.getMSG("GraphicsMRyCIndex027")";
        if (idB == 3) pnnc = "@Strings.getMSG("GraphicsMRyCIndex028")";
        $("#modalH").html("<center>@Strings.getMSG("GraphicsMRyCIndex017") '" + label + "' </center><br><center>" + pnnc + "</center>");
        $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
        $("#id_pc").val(idP);
        $("#id_pb").val(idB);
        $("#aviso").modal("show");
        $.ajax({
            dataType: "html",
            type: "post",
            cache: false,
            url: '@(Url.Action("DetailsCert", "GraphicsMRyC"))',
            data: $("#form1").serialize(),
            success: function (data) {
                $("#modalB").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("GraphicsMRyCIndex020")");
                $("#aviso").modal("hide");
            }
        });
    }

    function detailsNCert(idC, idCr, label, crs) {
        $("#modalH").html("<center>Criticidad '" + crs + "' @Strings.getMSG("GraphicsMRyCIndex029")</center><br><center> @Strings.getMSG("GraphicsMRyCIndex030")'"+ label +"'</center>");
        $("#modalB").html('<div class="row"><div class="col-md-offset-5 col-xs-offset-1 col-md-1 col-xs-1"><span id="ind1" class="IndicatorLoader centered"></span></div></div>');
        $("#id_pc").val(idC);
        $("#id_pb").val(idCr);
        $("#aviso").modal("show");
        $.ajax({
            dataType: "html",
            type: "post",
            cache: false,
            url: '@(Url.Action("DetailsNCert", "GraphicsMRyC"))',
            data: $("#form1").serialize(),
            success: function (data) {
                $("#modalB").html(data);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.error("@Strings.getMSG("GraphicsMRyCIndex020")");
                $("#aviso").modal("hide");
            }
        });
    }

</script>


<div id="contenedor1"></div>

<div class="modal fade" id="aviso" tabindex="-1" role="dialog" aria-labelledby="Aviso" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="font-size: 2em;" id="modalH">

            </div>
            <div id="modalB" class="modal-body">

            </div>
            <div id="modalF" class="modal-footer">

            </div>
        </div>
    </div>
</div>
<h2>@ViewBag.Title @Strings.getMSG("Menu077")</h2>

<ul class="nav nav-tabs">
    <li class="active"><a href="#pes0" data-toggle="tab"><h4>@Strings.getMSG("GraphicsMRyCIndex002")<span id="ind1"></span> </h4></a></li>
    <li><a href="#pes1" data-toggle="tab"><h4>@Strings.getMSG("GraphicsMRyCIndex011")<span id="ind1"></span> </h4></a></li>
    <li><a href="#pes2" data-toggle="tab"><h4>@Strings.getMSG("Menu118")<span id="ind2"></span></h4></a></li>
</ul>

<div id="myTabContent" class="tab-content">
    <!-- #region Generales -->
    <div class="tab-pane fade active in" id="pes0">
        <div class="form-horizontal well">
            <canvas id="g0" width="424" height="212" style="width: 424px; height: 212px;"></canvas>
            <button id="ctp" class="btn btn-default" onclick="gr0.destroy(); tg0 = 'pie'; gr0 = buildChart(data0, tg0, 'MRyC', g0, options1); $('#ctb').show(); $('#ctp').hide();">@Strings.getMSG("GraphicsMRyCIndex019")</button>
            <button id="ctb" class="btn btn-default" onclick="gr0.destroy(); tg0 = 'bar'; gr0 = buildChart(data0, tg0, 'MRyC', g0, options1); $('#ctp').show();  $('#ctb').hide()" style="display:none;">@Strings.getMSG("GraphicsMRyCIndex012")</button>
        </div>
    </div>
    <!-- #endregion -->
    <!-- #region Criticidades -->
    <div class="tab-pane" id="pes1">
        <div class="form-horizontal well">
            <canvas id="g1" width="424" height="212" style="width: 424px; height: 212px;"></canvas>
            <button id="ctp1" class="btn btn-default" onclick="gr1.destroy(); tg1 = 'pie'; gr1 = buildChart(data1, tg1, 'MRyC', g1, options1); $('#ctb1').show(); $('#ctp1').hide();" style="display:none;">@Strings.getMSG("GraphicsMRyCIndex019")</button>
            <button id="ctb1" class="btn btn-default" onclick="gr1.destroy(); tg1 = 'bar'; gr1 = buildChart(data1, tg1, 'MRyC', g1, options1); $('#ctp1').show();  $('#ctb1').hide()">@Strings.getMSG("GraphicsMRyCIndex012")</button>
        </div>
    </div>
    <!-- #endregion -->
    <!-- #region Análisis de Bajas en Proceso -->
    <div class="tab-pane" id="pes2">
        <div class="form-horizontal well">
            <canvas id="g2" width="424" height="212" style="width: 424px; height: 212px;"></canvas>
            <br />
            <br />
            <canvas id="g3" width="424" height="212" style="width: 424px; height: 212px;"></canvas>
        </div>
    </div>
    <!-- #endregion -->
</div>

<h4>@Strings.getMSG("Filtros")</h4>
<form id="form1">
    <div class="form-horizontal">

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Periodos")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        @Html.ListBox("periodos", (MultiSelectList)ViewBag.periodos, htmlAttributes: new { @class = "form-control selectpicker custom-picker", @id = "periodos", @name = "periodos" })
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex006")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Entidad")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        @Html.ListBox("entidades", (MultiSelectList)ViewBag.entidades, htmlAttributes: new { @class = "form-control selectpicker custom-picker", @id = "entidades", @name = "entidades" })
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex007")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Puestos")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        @Html.ListBox("puestos", (MultiSelectList)ViewBag.puestos, htmlAttributes: new { @class = "form-control selectpicker custom-picker", @id = "puestos", @name = "puestos" })
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex007")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Descendientes")</label>
                <div class="col-xs-2 col-md-1">
                    <div class="input-group">
                        <input type="checkbox" class="chbx" id="check2" name="check2" data-toggle="toggle" data-on="@Strings.getMSG("UsuarioIndex004")" data-off="@Strings.getMSG("UsuarioIndex005")" data-width="40" />
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex008")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Niveles")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        @Html.ListBox("niveles", (MultiSelectList)ViewBag.niveles, htmlAttributes: new { @class = "form-control selectpicker custom-picker", @id = "niveles", @name = "niveles" })
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex007")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Descendientes")</label>
                <div class="col-xs-2 col-md-1">
                    <div class="input-group">
                        <input type="checkbox" class="chbx" id="check3" name="check3" data-toggle="toggle" data-on="@Strings.getMSG("UsuarioIndex004")" data-off="@Strings.getMSG("UsuarioIndex005")" data-width="40" />
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex009")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="row">
            <div class="form-group">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("Usuario")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        @Html.ListBox("usuarios", (MultiSelectList)ViewBag.usuarios, htmlAttributes: new { @class = "form-control selectpicker custom-picker", @id = "usuarios", @name = "usuarios" })
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex007")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <div class="row">
            <div class="form-group" id="chbx">
                <label class="control-label col-xs-3 col-md-1">@Strings.getMSG("UOI")</label>
                <div class="col-xs-3 col-md-3">
                    <div class="input-group">
                        <input type="checkbox" class="chbx" id="check1" name="check1" data-toggle="toggle" data-on="@Strings.getMSG("Unir")" data-off="@Strings.getMSG("Intersectar")" data-width="232" />
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default" title="@Strings.getMSG("Atencion")" data-toggle="popover" data-trigger="hover" data-content="@Strings.getMSG("GraphicsMRyCIndex010")">
                                <i class="glyphicon glyphicon-question-sign"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <input type="text" hidden id="id_crit" name="id_crit" />
        <input type="text" hidden id="id_pc" name="id_pc" />
        <input type="text" hidden id="id_pb" name="id_pb" />
    </div>
</form>




