@model SCIRA.Models.c_entidad
@using SCIRA.Utilidades;
@using SCIRA.Models;

@{
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    ViewBag.Title = "Universo certificado";

    c_periodo_certificacion periodo = ViewBag.periodo;


    string certEntidad = (@Strings.getMSG("CertificacionInforme004"));
    var certEn = Model.k_certificacion_estructura.FirstOrDefault(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion);

    if(certEn != null)
    {
        certEntidad = certEn.resultado ? (@Strings.getMSG("CertificacionInforme032")) : (@Strings.getMSG("CertificacionInforme033"));
    }

    int totalMPC = 0;
    int totalMPNC = 0;
    int totalMPSinC = 0;
    int totalPRC = 0;
    int totalPRNC = 0;
    int totalPRSinC = 0;
    int totalSPC = 0;
    int totalSPNC = 0;
    int totalSPSinC = 0;
    int totalCTRLC = 0;
    int totalCTRLNC = 0;
    int totalCTRLSinC = 0;

}

<style>
    .card-header {
        font-size: 1.7rem;
        font-weight: bold;
    }

    .card-body {
        font-size: 1.6rem;
    }
</style>

<script>
    var modalOptions = {
        title: "@Strings.getMSG("AuditoriaCreateUniversoAuditableCreate013")",
        size: "xl",
        show: true,
        loadUrl: "@(Url.Action("SelectorPeriodo"))"
    }

    function selectorPeriodo(id) {
        menuModal.initModal(modalOptions);
    }

    var Url = "@(Url.Action("UniversoCertificado"))?id=@(Model.id_entidad)&id_periodo=";

    function goToPeriod(id) {
        window.location.href = Url + id;
    }
</script>



<h2><span class="catalogName">@Strings.getMSG("Universo Certificado")</span></h2>

<h3>@Strings.getMSG("CertificacionInforme036") @Model.nb_entidad</h3>

@Html.ActionLink(Strings.getMSG("Regresar"), "Index", new { id = periodo.id_periodo_certificacion }, new { @class = "btn btn-default" })

<div class="row" style="margin-top: 20px;">
    <div class="card-group" style="margin:0 0 20px 0">
        <div class="card hover" onclick="selectorPeriodo();">
            <div class="card-header text-center">@Strings.getMSG("CertificacionesEntidad001")</div>
            <div class="card-body text-center">
                @if (periodo != null)
                {
                    @(periodo.nb_periodo_certificacion + " - " + periodo.anio)
                }
                else
                {
                    @("N/A")
                }
            </div>
        </div>
    </div>
</div>

<table id="results" class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th rowspan="2">@Model.nb_entidad @certEntidad</th>
            <th colspan="3" style="min-width: 300px"><center>@Strings.getMSG("CertificacionInforme001")</center></th>
        </tr>
        <tr>
            <th><center>@Strings.getMSG("CertificacionInforme002")</center></th>
            <th><center>@Strings.getMSG("CertificacionInforme003")</center></th>
            <th><center>@Strings.getMSG("CertificacionInforme039")</center></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var mp in Model.c_macro_proceso)
        {
            //certificación del macro proceso
            var certMP = mp.k_certificacion_estructura.FirstOrDefault(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion);
            string resCertMP = (@Strings.getMSG("CertificacionInforme004"));
            if (certMP != null)
            {
                resCertMP = certMP.resultado ? (@Strings.getMSG("CertificacionInforme034")) : (@Strings.getMSG("CertificacionInforme035"));

                if (certMP.resultado)
                {
                    totalMPC++;
                }
                else
                {
                    totalMPNC++;
                }
            }



            //procesos certificados
            var prc = mp.c_proceso.Where(p => p.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion));
            var certsPR = prc.Select(p => p.k_certificacion_estructura.First(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion)).ToList();


            //sub procesos y controles certificados
            List<c_sub_proceso> spc = new List<c_sub_proceso>();
            List<c_sub_proceso> sps = new List<c_sub_proceso>();
            List<k_control> ctrc = new List<k_control>();
            List<k_control> ctrs = new List<k_control>();
            int controlesConAccionCorrectora = 0;

            foreach (var p in mp.c_proceso)
            {
                spc.AddRange(p.c_sub_proceso.Where(sp => sp.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion)));
                sps.AddRange(p.c_sub_proceso);


                foreach (var sp in p.c_sub_proceso)
                {
                    controlesConAccionCorrectora += sp.k_control.Where(c => c.tiene_accion_correctora).Count();
                    ctrc.AddRange(sp.k_control.Where(ctr => ctr.k_certificacion_control.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion)));
                    ctrs.AddRange(sp.k_control);
                }
            }
            var certsSP = spc.Select(p => p.k_certificacion_estructura.First(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion)).ToList();

            var certsCTR = ctrc.Select(ctr => ctr.k_certificacion_control.First(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion));

            totalPRC += certsPR.Where(c => c.resultado).Count();
            totalPRNC += certsPR.Where(c => !c.resultado).Count();

            totalSPC += certsSP.Where(c => c.resultado).Count();
            totalSPNC += certsSP.Where(c => !c.resultado).Count();

            totalCTRLC += certsCTR.Where(c => c.tiene_disenio_efectivo && c.tiene_funcionamiento_efectivo).Count();
            totalCTRLNC += certsCTR.Where(c => !c.tiene_disenio_efectivo || !c.tiene_funcionamiento_efectivo).Count();

            //agregar el número de controles con accion correctora a las certificaciones negativas
            totalCTRLNC += controlesConAccionCorrectora;

            <tr>
                <td colspan="4" style="font-weight:bold;">
                    @(mp.cl_macro_proceso + " - " + mp.nb_macro_proceso + resCertMP)
                </td>
            </tr>
            <tr>
                <td>@Strings.getMSG("PS")</td>
                <td>@(certsPR.Where(c=>c.resultado).Count())</td>
                <td>@(certsPR.Where(c=>!c.resultado).Count())</td>
                <td>@((mp.c_proceso.Where(p => !p.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
            </tr>
            <tr>
                <td>@Strings.getMSG("SPS")</td>
                <td>@(certsSP.Where(c=>c.resultado).Count())</td>
                <td>@(certsSP.Where(c=>!c.resultado).Count())</td>
                <td>@((sps.Where(sp => !sp.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
            </tr>
            <tr>
                <td>@Strings.getMSG("Controles")</td>
                <td>@(certsCTR.Where(c=>c.tiene_disenio_efectivo && c.tiene_funcionamiento_efectivo).Count())</td>
                <td>@(certsCTR.Where(c=> !c.tiene_disenio_efectivo || !c.tiene_funcionamiento_efectivo).Count() + controlesConAccionCorrectora)</td>
                <td>@((ctrs.Where(ct => !ct.k_certificacion_control.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
            </tr>

        }


        @{ 
            var MacroProcesos = Model.c_macro_proceso.ToList();
            var Procesos = MacroProcesos.SelectMany(mp => mp.c_proceso);
            var SubProcesos = Procesos.SelectMany(p => p.c_sub_proceso);
            var Controles = SubProcesos.SelectMany(sp => sp.k_control);
        }
    <tr>
        <td style="font-weight:bold">@Strings.getMSG("CertificacionInforme005")</td>
        <td>@(totalPRC)</td>
        <td>@(totalPRNC)</td>
        <td>@((MacroProcesos.Where(mp => !mp.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
    </tr>
    <tr>
        <td style="font-weight:bold">@Strings.getMSG("CertificacionInforme006")</td>
        <td>@(totalPRC)</td>
        <td>@(totalPRNC)</td>
        <td>@((Procesos.Where(p => !p.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
    </tr>
    <tr>
        <td style="font-weight:bold">@Strings.getMSG("CertificacionInforme007")</td>
        <td>@(totalSPC)</td>
        <td>@(totalSPNC)</td>
        <td>@((SubProcesos.Where(sp => !sp.k_certificacion_estructura.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
    </tr>
    <tr>
        <td style="font-weight:bold">@Strings.getMSG("CertificacionInforme008")</td>
        <td>@(totalCTRLC)</td>
        <td>@(totalCTRLNC)</td>
        <td>@((Controles.Where(ct => !ct.k_certificacion_control.Any(c => c.id_periodo_certificacion == periodo.id_periodo_certificacion))).Count())</td>
    </tr>

    </tbody>
</table>
